#!/usr/bin/env python

import argparse
import datetime
import sys
import json

import yaml

import sqlalchemy as sa
from shotgun_api3_registry import connect
from sgsession import Session

from sgcache.schema.core import Schema

session = Session(connect())
session.shotgun.config.convert_datetimes_to_utc = False

parser = argparse.ArgumentParser()
parser.add_argument('-p', '--project', type=int)
parser.add_argument('-t', '--type', action='append')
parser.add_argument('-u', '--url', required=True)
parser.add_argument('-s', '--schema', required=True)
parser.add_argument('data', default='-')
args = parser.parse_args()

db = sa.create_engine(args.url)

schema_spec = yaml.load(open(args.schema).read())
schema = Schema(db, schema_spec)

data_iter = sys.stdin if args.data == '-' else open(args.data)

for line in data_iter:
    line = line.strip()
    if not line:
        continue
    data = json.loads(line.strip())
    print schema.create(data.pop('type'), data, allow_id=True)

    # break
